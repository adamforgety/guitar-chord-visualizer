<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Fretboard Visualizer (Accurate Scales & Intervals)</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for the visualizer */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .key-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }
        /* Ensure the body takes up full height for mobile responsiveness */
        body {
            height: 100vh;
        }
        /* Highlight for the active mode button */
        .mode-active {
            @apply bg-blue-600 text-white shadow-lg;
        }
    </style>
</head>
<body class="p-1 h-screen flex items-center justify-center">

    <div class="w-full max-w-4xl bg-white rounded-xl shadow-2xl p-4 md:p-6 h-[98%] overflow-y-auto">
        <header class="mb-6">
            <h1 class="text-3xl md:text-4xl font-extrabold text-gray-900 mb-1 text-center">
                Guitar Fretboard Visualizer
            </h1>
            <p class="text-center text-gray-600 text-sm md:text-base">
                Visualize Chords or Scales with accurate note and interval labels.
            </p>
        </header>
        
        <!-- Mode Switch -->
        <div class="flex justify-center mb-6 max-w-sm mx-auto p-1 bg-gray-100 rounded-lg key-shadow">
            <button id="modeChord" data-mode="chord" class="flex-1 py-2 text-sm font-semibold rounded-lg transition mode-active">Chord Mode</button>
            <button id="modeScale" data-mode="scale" class="flex-1 py-2 text-sm font-semibold rounded-lg transition text-gray-700 hover:bg-gray-200">Scale Mode</button>
        </div>

        <!-- Selection Controls: 3 Dropdowns for maximum flexibility -->
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-6 max-w-2xl mx-auto">

            <!-- 1. Root Note Selector -->
            <div class="space-y-1">
                <label for="rootNote" class="block text-sm font-medium text-gray-700">Root Note</label>
                <select id="rootNote" class="block w-full pl-3 pr-10 py-2.5 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-lg rounded-lg border key-shadow bg-gray-50">
                    <!-- Options populated by JS -->
                </select>
            </div>

            <!-- 2. Type Selector (Chord Type or Scale Type) -->
            <div class="space-y-1">
                <label id="typeLabel" for="typeSelector" class="block text-sm font-medium text-gray-700">Chord Type</label>
                <select id="typeSelector" class="block w-full pl-3 pr-10 py-2.5 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-lg rounded-lg border key-shadow bg-gray-50">
                    <!-- Options populated by JS -->
                </select>
            </div>

             <!-- 3. Position/Shape Selector -->
            <div class="space-y-1">
                <label id="positionLabel" for="positionSelector" class="block text-sm font-medium text-gray-700">Position / Shape</label>
                <select id="positionSelector" class="block w-full pl-3 pr-10 py-2.5 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-lg rounded-lg border key-shadow bg-gray-50">
                    <!-- Options populated by JS -->
                </select>
            </div>
        </div>

        <!-- Visualization Area -->
        <div class="flex flex-col items-center">
            <h2 id="resultName" class="text-xl font-semibold text-gray-800 mb-3 text-center h-6"></h2>
            
            <!-- Message Area for Chords/Scales that don't exist -->
            <p id="messageArea" class="text-red-500 mb-4 h-6 text-center"></p>
            
            <!-- Fretboard Container: Fixed aspect ratio for vertical chart -->
            <div id="fretboardContainer" class="relative w-full max-w-md p-2 bg-gray-100 rounded-lg key-shadow">
                <svg id="fretboardSvg" width="100%" height="300" preserveAspectRatio="xMidYMid meet"></svg>
            </div>

            <!-- Legend for Scale Mode -->
            <div id="legend" class="mt-4 p-3 bg-white rounded-xl shadow hidden text-sm text-gray-700 border border-gray-200">
                <h3 class="font-bold mb-2 text-center text-gray-800">Scale Note Intervals</h3>
                <div class="flex flex-wrap justify-center gap-x-4 gap-y-2">
                    <span class="flex items-center"><span class="w-3 h-3 rounded-full mr-1 bg-red-500"></span> Root (R)</span>
                    <span class="flex items-center"><span class="w-3 h-3 rounded-full mr-1 bg-yellow-400"></span> Third (3)</span>
                    <span class="flex items-center"><span class="w-3 h-3 rounded-full mr-1 bg-green-500"></span> Fifth (5)</span>
                    <span class="flex items-center"><span class="w-3 h-3 rounded-full mr-1 bg-blue-500"></span> Other Notes</span>
                </div>
            </div>
            
        </div>
    </div>

    <script>
        // --- Core Configuration Data ---
        const NOTE_INFO = [
            { id: 0, name: "C" }, { id: 1, name: "C#" }, { id: 2, name: "D" }, 
            { id: 3, name: "D#" }, { id: 4, name: "E" }, { id: 5, name: "F" }, 
            { id: 6, name: "F#" }, { id: 7, name: "G" }, { id: 8, name: "G#" }, 
            { id: 9, name: "A" }, { id: 10, name: "A#" }, { id: 11, name: "B" }
        ];

        // Standard guitar tuning in semitone indices (E A D G B E)
        const STRING_TUNING = [4, 9, 2, 7, 11, 4]; // Low E (6th, Index 0) to High E (1st, Index 5)
        
        // --- CHORD DATA (Truncated for space, full data remains the same) ---
        const CHORD_DEFINITIONS = {
            'major': { name: 'Major', intervals: [0, 4, 7] },
            'minor': { name: 'Minor', intervals: [0, 3, 7] },
            'dom7': { name: '7th', intervals: [0, 4, 7, 10] },
            'min7': { name: 'minor 7th', intervals: [0, 3, 7, 10] },
            'maj7': { name: 'Major 7th', intervals: [0, 4, 7, 11] }, 
            'sus2': { name: 'sus2', intervals: [0, 2, 7] },          
            'sus4': { name: 'sus4', intervals: [0, 5, 7] },          
        };
        const OPEN_CHORDS = { 
            '9_major': { finger: ['X', 0, 2, 2, 2, 0], rootString: 1, name: 'A Major' }, 
            '0_major': { finger: ['X', 3, 2, 0, 1, 0], rootString: 1, name: 'C Major' }, 
            '2_major': { finger: ['X', 'X', 0, 2, 3, 2], rootString: 3, name: 'D Major' },
            '4_major': { finger: [0, 2, 2, 1, 0, 0], rootString: 0, name: 'E Major' },
            '7_major': { finger: [3, 2, 0, 0, 0, 3], rootString: 0, name: 'G Major' },
            '9_minor': { finger: ['X', 0, 2, 2, 1, 0], rootString: 1, name: 'A minor' }, 
            '2_minor': { finger: ['X', 'X', 0, 2, 3, 1], rootString: 3, name: 'D minor' },
            '4_minor': { finger: [0, 2, 2, 0, 0, 0], rootString: 0, name: 'E minor' },
            // ... (other open chords)
        };
        const SHAPES = {
            'open_position': { name: "Open Position" }, 
            'e_shape': {
                name: "E-Shape (6th String Root)",
                voicings: {
                    'major':    [1, 3, 3, 2, 1, 1], 
                    'minor':    [1, 3, 3, 1, 1, 1], 
                    'dom7':     [1, 3, 2, 2, 1, 1], 
                    'min7':     [1, 3, 1, 2, 1, 1],
                    'maj7':     [1, 3, 2, 3, 4, 1], 
                    'sus2':     [1, 3, 3, 1, 1, 1], 
                    'sus4':     [1, 3, 4, 4, 1, 1], 
                },
                rootStringIndex: 0
            },
            'a_shape': {
                name: "A-Shape (5th String Root)",
                voicings: {
                    'major':    ['X', 1, 3, 3, 3, 1], 
                    'minor':    ['X', 1, 3, 3, 2, 1], 
                    'dom7':     ['X', 1, 3, 2, 3, 1], 
                    'min7':     ['X', 1, 2, 2, 3, 1],
                    'maj7':     ['X', 1, 3, 2, 1, 1], 
                    'sus2':     ['X', 1, 3, 3, 1, 1], 
                    'sus4':     ['X', 1, 3, 3, 4, 1], 
                },
                rootStringIndex: 1
            },
        };
        const SHAPE_ORDER = ['open_position', 'e_shape', 'a_shape'];

        // --- SCALE DATA (ACCURATE INTERVALS) ---
        const SCALE_DEFINITIONS = {
            // Intervals are half steps from the root (0)
            'major': { name: 'Major (Ionian)', intervals: [0, 2, 4, 5, 7, 9, 11] },
            'minor': { name: 'Natural Minor (Aeolian)', intervals: [0, 2, 3, 5, 7, 8, 10] },
            'pentatonic_min': { name: 'Minor Pentatonic', intervals: [0, 3, 5, 7, 10] },
        };

        // Scale positions simply define the starting fret of the 5-fret window
        const SCALE_POSITIONS = [
            { key: 'p1', name: 'Position 1 (Starts Fret 1)', startFret: 1 },
            { key: 'p3', name: 'Position 3 (Starts Fret 3)', startFret: 3 },
            { key: 'p5', name: 'Position 5 (Starts Fret 5)', startFret: 5 },
            { key: 'p7', name: 'Position 7 (Starts Fret 7)', startFret: 7 },
            { key: 'p10', name: 'Position 10 (Starts Fret 10)', startFret: 10 },
        ];

        // --- Fretboard & SVG Configuration ---
        const SVG_CONFIG = {
            TOTAL_FRETS: 5,
            TOTAL_STRINGS: 6,
            FRET_HEIGHT: 40, 
            STRING_SPACING: 45, 
            CHART_START_X: 60,
            CHART_START_Y: 40, 
            NUT_THICKNESS: 8,
            FINGER_RADIUS: 12,
            COLOR_ROOT: '#ef4444',     // Red-500
            COLOR_THIRD: '#facc15',    // BRIGHT YELLOW (Yellow-400)
            COLOR_FIFTH: '#10b981',    // Green-500
            COLOR_OTHER: '#3b82f6',    // Blue-500
        };

        // --- DOM Elements & State ---
        const modeChordButton = document.getElementById('modeChord');
        const modeScaleButton = document.getElementById('modeScale');
        const rootNoteSelect = document.getElementById('rootNote');
        const typeSelector = document.getElementById('typeSelector');
        const positionSelector = document.getElementById('positionSelector');
        const typeLabel = document.getElementById('typeLabel');
        const positionLabel = document.getElementById('positionLabel');
        const resultNameH2 = document.getElementById('resultName');
        const messageAreaP = document.getElementById('messageArea');
        const fretboardSvg = document.getElementById('fretboardSvg');
        const legendDiv = document.getElementById('legend');

        let currentMode = 'chord'; 

        // --- Helper Functions ---

        /**
         * Calculates the note name (string) from the open string index and fret number.
         * @param {number} stringIndex - 0 (Low E) to 5 (High E)
         * @param {number} fret - Absolute fret number (0 to 12+)
         * @returns {string} The note name (e.g., "C#")
         */
        function getNoteName(stringIndex, fret) {
            if (fret === 'X' || fret === 0) return '';
            const stringTuningNote = STRING_TUNING[stringIndex];
            const noteIndex = (stringTuningNote + fret) % 12;
            return NOTE_INFO[noteIndex].name;
        }

        /**
         * Calculates the interval (in half steps) of a note relative to the root.
         * @param {number} rootIndex - The root note ID (0-11)
         * @param {number} noteIndex - The note ID (0-11)
         * @returns {number} The interval in half steps (0-11)
         */
        function getInterval(rootIndex, noteIndex) {
            return (noteIndex - rootIndex + 12) % 12;
        }

        /**
         * Determines the color for a scale note based on its interval.
         */
        function getScaleNoteColor(interval) {
            switch (interval) {
                case 0: return SVG_CONFIG.COLOR_ROOT;
                case 3: // Minor 3rd
                case 4: // Major 3rd
                    return SVG_CONFIG.COLOR_THIRD;
                case 7: // Perfect 5th
                    return SVG_CONFIG.COLOR_FIFTH;
                default:
                    return SVG_CONFIG.COLOR_OTHER;
            }
        }


        // --- MODE LOGIC ---

        function updateMode(newMode) {
            currentMode = newMode;

            // Update button styling
            modeChordButton.classList.toggle('mode-active', currentMode === 'chord');
            modeScaleButton.classList.toggle('mode-active', currentMode === 'scale');
            modeChordButton.classList.toggle('text-gray-700', currentMode === 'scale');
            modeScaleButton.classList.toggle('text-gray-700', currentMode === 'chord');
            modeChordButton.classList.toggle('hover:bg-gray-200', currentMode === 'scale');
            modeScaleButton.classList.toggle('hover:bg-gray-200', currentMode === 'chord');
            
            // Toggle legend visibility
            legendDiv.classList.toggle('hidden', currentMode === 'chord');
            
            // Populate dropdowns based on mode
            populateTypeAndPositionSelectors();
            
            // Run visualization
            updateVisualization();
        }

        function populateTypeAndPositionSelectors() {
            typeSelector.innerHTML = '';
            positionSelector.innerHTML = '';

            if (currentMode === 'chord') {
                typeLabel.textContent = 'Chord Type';
                positionLabel.textContent = 'Position / Shape';
                
                // 2. Chord Types
                typeSelector.innerHTML = Object.entries(CHORD_DEFINITIONS).map(([key, def]) => 
                    `<option value="${key}">${def.name}</option>`
                ).join('');

                // 3. Position/Shapes
                positionSelector.innerHTML = SHAPE_ORDER.map(key => 
                    `<option value="${key}">${SHAPES[key].name}</option>`
                ).join('');

                typeSelector.value = 'major';
                positionSelector.value = 'open_position';
            } else { // Scale mode
                typeLabel.textContent = 'Scale Type';
                positionLabel.textContent = 'Fret Start Position';

                // 2. Scale Types
                typeSelector.innerHTML = Object.entries(SCALE_DEFINITIONS).map(([key, def]) => 
                    `<option value="${key}">${def.name}</option>`
                ).join('');

                // 3. Scale Positions
                positionSelector.innerHTML = SCALE_POSITIONS.map(pos => 
                    `<option value="${pos.startFret}">${pos.name}</option>`
                ).join('');

                typeSelector.value = 'major';
                positionSelector.value = SCALE_POSITIONS[0].startFret;
            }
        }
        
        // --- CHORD CALCULATION LOGIC ---

        function calculateChordFingering(rootIndex, typeKey, shapeKey) {
            const rootNoteName = NOTE_INFO[rootIndex].name;
            const chordTypeName = CHORD_DEFINITIONS[typeKey].name;

            // 1. Handle Open Position (Fixed Fingerings)
            if (shapeKey === 'open_position') {
                const lookupKey = `${rootIndex}_${typeKey}`;
                const openChordData = OPEN_CHORDS[lookupKey]; 
                
                if (!openChordData) {
                    return { error: `No standard ${rootNoteName} ${chordTypeName} found in the Open Position.` };
                }
                
                const fingering = openChordData.finger.map((fretValue, i) => {
                    const absoluteFret = fretValue === 'X' ? fretValue : fretValue;
                    const isRoot = (i === openChordData.rootString && fretValue !== 'X');
                    const noteName = fretValue === 'X' ? '' : getNoteName(i, absoluteFret);

                    return { 
                        string: i, 
                        fret: fretValue,
                        isRoot: isRoot,
                        noteName: noteName,
                        color: isRoot ? SVG_CONFIG.COLOR_ROOT : SVG_CONFIG.COLOR_OTHER // Simple coloring for chords
                    };
                });
                
                return { 
                    name: `${rootNoteName} ${chordTypeName} (Open Position)`,
                    fingering: fingering,
                    barreFret: null, 
                    displayStartFret: 1,
                    stringsToBarre: []
                };
            }
            
            // 2. Handle Transposable Barre Shapes (E-Shape / A-Shape)
            const shapeData = SHAPES[shapeKey];
            const fretPattern = shapeData.voicings[typeKey];
            const rootStringIndex = shapeData.rootStringIndex;
            
            const stringRootNote = STRING_TUNING[rootStringIndex];
            const fretDiff = (rootIndex - stringRootNote + 12) % 12;
            const barreFret = fretDiff === 0 ? 12 : fretDiff; 

            let highestFrettedNote = 0;
            let stringsToBarre = [];

            const fingering = fretPattern.map((patternValue, stringIndex) => {
                if (patternValue === 'X' || patternValue === 0) {
                    return { string: stringIndex, fret: patternValue };
                }
                
                const finalFret = barreFret + (patternValue - 1);
                
                if (finalFret > highestFrettedNote) { highestFrettedNote = finalFret; }

                if (patternValue === 1) { stringsToBarre.push(stringIndex); }
                
                const isRoot = (stringIndex === rootStringIndex && patternValue === 1);
                const noteName = getNoteName(stringIndex, finalFret);

                return { 
                    string: stringIndex, 
                    fret: finalFret, 
                    isRoot: isRoot,
                    noteName: noteName,
                    color: isRoot ? SVG_CONFIG.COLOR_ROOT : SVG_CONFIG.COLOR_OTHER
                };
            });
            
            const showBarre = (stringsToBarre.length >= 2); 
            
            let finalDisplayStartFret = 1;
            if (highestFrettedNote > SVG_CONFIG.TOTAL_FRETS) {
                finalDisplayStartFret = Math.max(1, highestFrettedNote - SVG_CONFIG.TOTAL_FRETS + 1);
            }

            return { 
                name: `${rootNoteName} ${chordTypeName} (${shapeData.name} @ ${barreFret}fr)`,
                fingering: fingering,
                barreFret: showBarre ? barreFret : null,
                displayStartFret: finalDisplayStartFret,
                stringsToBarre: showBarre ? stringsToBarre : []
            };
        }
        
        // --- SCALE CALCULATION LOGIC (ACCURATE MAPPING) ---

        function calculateScaleFingering(rootIndex, scaleTypeKey, startFret) {
            const rootNoteName = NOTE_INFO[rootIndex].name;
            const scaleDef = SCALE_DEFINITIONS[scaleTypeKey];
            
            if (!scaleDef) {
                 return { error: `Scale definition for ${scaleTypeKey} not found.` };
            }
            
            const displayStartFret = parseInt(startFret);
            const displayEndFret = displayStartFret + SVG_CONFIG.TOTAL_FRETS - 1;

            const fingering = [];

            // Iterate through every position in the 5-fret window
            for (let stringIndex = 0; stringIndex < SVG_CONFIG.TOTAL_STRINGS; stringIndex++) {
                // Determine the range of frets to check (including Fret 0 if the chart starts at 1)
                const startFretLoop = displayStartFret === 1 ? 0 : displayStartFret;
                const endFretLoop = displayEndFret;

                for (let fret = startFretLoop; fret <= endFretLoop; fret++) {
                    
                    // Skip fret 0 if it's not the start position
                    if (fret === 0 && displayStartFret > 1) continue;
                    
                    const stringTuningNote = STRING_TUNING[stringIndex];
                    const absoluteNoteIndex = (stringTuningNote + fret) % 12;
                    
                    // Calculate the note's interval relative to the selected root
                    const interval = getInterval(rootIndex, absoluteNoteIndex);

                    // Check if this interval is part of the selected scale
                    if (scaleDef.intervals.includes(interval)) {
                        
                        const isRoot = (interval === 0);
                        const noteName = NOTE_INFO[absoluteNoteIndex].name;

                        // For display, use 0 for the open string dot, and actual fret number for fretted notes
                        const fretToDisplay = fret;
                        
                        // Add note, ensuring we only push fretted notes within the window or open notes
                        if (fretToDisplay === 0 || (fretToDisplay >= displayStartFret && fretToDisplay <= displayEndFret)) {
                             // Check for duplicates
                            if (!fingering.some(f => f.string === stringIndex && f.fret === fretToDisplay)) {
                                fingering.push({
                                    string: stringIndex,
                                    fret: fretToDisplay,
                                    isRoot: isRoot,
                                    noteName: noteName,
                                    color: getScaleNoteColor(interval),
                                });
                            }
                        }
                    }
                }
            }

            // Generate descriptive name
            let name = `${rootNoteName} ${scaleDef.name}`;
            if (displayStartFret > 1) {
                name += ` (Fret ${displayStartFret} to ${displayEndFret})`;
            } else {
                name += ` (Open Position Map)`;
            }

            return { 
                name: name,
                fingering: fingering,
                barreFret: null, 
                displayStartFret: displayStartFret,
                stringsToBarre: []
            };
        }

        /**
         * Draws the vertical chord/scale diagram using SVG.
         */
        function drawFretboard(chordData) {
            const svg = fretboardSvg;
            svg.innerHTML = '';
            
            const { fingering, barreFret, stringsToBarre, displayStartFret } = chordData;
            
            const FRET_H = SVG_CONFIG.FRET_HEIGHT;
            const STRING_W = SVG_CONFIG.STRING_SPACING * (SVG_CONFIG.TOTAL_STRINGS - 1);
            const START_X = SVG_CONFIG.CHART_START_X; 
            const START_Y = SVG_CONFIG.CHART_START_Y;
            const TOTAL_FRETS = SVG_CONFIG.TOTAL_FRETS;
            const TOTAL_STRINGS = SVG_CONFIG.TOTAL_STRINGS;
            const FINGER_R = SVG_CONFIG.FINGER_RADIUS;

            const showNut = (displayStartFret === 1); 
            
            // Calculate actual height needed for SVG
            const svgHeight = START_Y + TOTAL_FRETS * FRET_H + 50; 
            svg.setAttribute('height', svgHeight);
            
            // --- 1. Draw Fret Lines (Horizontal) ---

            if (showNut && currentMode === 'chord') {
                // Draw the thick Nut (Fret 0) - only for open chords
                svg.innerHTML += `<rect x="${START_X - 2}" y="${START_Y - SVG_CONFIG.NUT_THICKNESS / 2}" width="${STRING_W + 4}" height="${SVG_CONFIG.NUT_THICKNESS}" fill="#374151"/>`;
            } else {
                // Draw the start fret line
                svg.innerHTML += `<line x1="${START_X}" y1="${START_Y}" x2="${START_X + STRING_W}" y2="${START_Y}" stroke="#374151" stroke-width="2" />`;
                
                // Fret label for the chart start
                svg.innerHTML += `<text x="${START_X - 20}" y="${START_Y + 7}" text-anchor="end" font-size="14" fill="#374151">${displayStartFret}fr</text>`;
            }

            // Draw the remaining fret lines
            for (let i = 1; i <= TOTAL_FRETS; i++) {
                const y = START_Y + i * FRET_H;
                svg.innerHTML += `<line x1="${START_X}" y1="${y}" x2="${START_X + STRING_W}" y2="${y}" stroke="#374151" stroke-width="2" />`;
            }

            // --- 2. Draw String Lines (Vertical) ---
            for (let i = 0; i < TOTAL_STRINGS; i++) {
                const x = START_X + i * SVG_CONFIG.STRING_SPACING;
                const y2 = START_Y + TOTAL_FRETS * FRET_H;
                svg.innerHTML += `<line x1="${x}" y1="${START_Y}" x2="${x}" y2="${y2}" stroke="#374151" stroke-width="1" />`;
            }

            // --- 3. Draw Barre Line (Only in Chord Mode) ---
            if (currentMode === 'chord' && barreFret !== null && stringsToBarre.length > 0) {
                const barreFretOffset = barreFret - displayStartFret;
                
                if (barreFretOffset >= 0 && barreFretOffset < TOTAL_FRETS) {
                    const barreY = START_Y + barreFretOffset * FRET_H + FRET_H / 2;
                    
                    const firstBarreStringX = START_X + stringsToBarre[0] * SVG_CONFIG.STRING_SPACING;
                    const lastBarreStringX = START_X + stringsToBarre[stringsToBarre.length - 1] * SVG_CONFIG.STRING_SPACING;

                    svg.innerHTML += `<line 
                        x1="${firstBarreStringX}" y1="${barreY}" 
                        x2="${lastBarreStringX}" y2="${barreY}" 
                        stroke="#3b82f6" stroke-width="12" stroke-linecap="round" opacity="0.6"/>`;
                        
                    svg.innerHTML += `<text 
                        x="${START_X - 25}" 
                        y="${barreY + 6}" 
                        text-anchor="end" 
                        font-size="18" 
                        font-weight="extrabold" 
                        fill="#3b82f6">
                        ${barreFret}fr
                    </text>`;
                }
            }


            // --- 4. Draw Finger Dots (Notes) ---
            // Sort by fret to ensure open/muted notes are drawn properly if start fret is 1
            fingering.sort((a, b) => a.fret - b.fret).forEach(f => {
                const stringX = START_X + f.string * SVG_CONFIG.STRING_SPACING;
                
                if (f.fret === 'X') {
                    svg.innerHTML += `<text x="${stringX}" y="${START_Y - 10}" text-anchor="middle" font-size="20" font-weight="bold" fill="#ef4444">X</text>`;
                } else if (f.fret === 0) {
                    // Open string (Above the start line)
                    const fill = f.color || 'transparent';
                    // Use color as fill for scales, transparent with border for chords
                    const stroke = (currentMode === 'chord' && fill === 'transparent') ? '#374151' : 'none'; 
                    
                    svg.innerHTML += `<circle cx="${stringX}" cy="${START_Y - 10}" r="6" fill="${fill}" stroke="${stroke}" stroke-width="2"/>`;
                    
                    // Add label for open notes in Scale Mode
                    if (currentMode === 'scale' && fill !== 'transparent') {
                        const noteText = f.noteName;
                        const fontSize = (noteText && noteText.length > 1) ? 8 : 10;
                         svg.innerHTML += `<text x="${stringX}" y="${START_Y - 7}" text-anchor="middle" font-weight="bold" font-size="${fontSize}" fill="white">${noteText}</text>`;
                    }

                } else {
                    const fretNumber = f.fret;
                    const fretOffset = fretNumber - displayStartFret;
                    
                    if (fretOffset >= 0 && fretOffset < TOTAL_FRETS) {
                        const fingerY = START_Y + fretOffset * FRET_H + FRET_H / 2;
                        
                        let isCoveredByBarre = (currentMode === 'chord' && barreFret === fretNumber && stringsToBarre.includes(f.string));

                        if (!isCoveredByBarre) {
                            const fill = f.color || SVG_CONFIG.COLOR_OTHER;
                            const noteText = f.noteName; 
                            
                            // Draw the finger dot
                            svg.innerHTML += `<circle cx="${stringX}" cy="${fingerY}" r="${FINGER_R}" fill="${fill}" class="key-shadow"/>`;
                            
                            // Draw the note name inside the dot
                            const fontSize = (noteText && noteText.length > 1) ? 10 : 12;
                            svg.innerHTML += `<text x="${stringX}" y="${fingerY + 4}" text-anchor="middle" font-weight="bold" font-size="${fontSize}" fill="white">${noteText}</text>`;
                        }
                    }
                }
            });

            // --- 5. Draw Fret Markers (Dots for 3, 5, etc.) ---
            const dotFrets = [3, 5, 7, 9, 12];
            const dotX = START_X + STRING_W / 2;
            const dotR = 5;

            dotFrets.forEach(absoluteFret => {
                const fretOffset = absoluteFret - displayStartFret;
                
                if (fretOffset > 0 && fretOffset <= TOTAL_FRETS) {
                    const markerY = START_Y + fretOffset * FRET_H; 
                    
                    if (absoluteFret % 12 === 0) { 
                        svg.innerHTML += `<circle cx="${dotX - 15}" cy="${markerY}" r="${dotR}" fill="#cccccc"/>`;
                        svg.innerHTML += `<circle cx="${dotX + 15}" cy="${markerY}" r="${dotR}" fill="#cccccc"/>`;
                    } else if ([3, 5, 7, 9].includes(absoluteFret)) { 
                        svg.innerHTML += `<circle cx="${dotX}" cy="${markerY}" r="${dotR}" fill="#cccccc"/>`;
                    }
                }
            });
        }

        /**
         * Main function to update the visualization based on user selection.
         */
        function updateVisualization() {
            const rootIndex = parseInt(rootNoteSelect.value);
            const typeKey = typeSelector.value;
            const positionKey = positionSelector.value;
            
            // Clear message area
            messageAreaP.textContent = '';
            fretboardSvg.innerHTML = ''; 
            resultNameH2.textContent = '';

            let chordData;

            if (currentMode === 'chord') {
                chordData = calculateChordFingering(rootIndex, typeKey, positionKey);
            } else {
                // Pass the starting fret number directly
                chordData = calculateScaleFingering(rootIndex, typeKey, positionKey);
            }

            if (chordData && chordData.error) {
                const typeName = currentMode === 'chord' ? CHORD_DEFINITIONS[typeKey].name : SCALE_DEFINITIONS[typeKey].name;
                resultNameH2.textContent = `${NOTE_INFO[rootIndex].name} ${typeName}`;
                messageAreaP.textContent = chordData.error;
                return;
            }

            if (chordData) {
                resultNameH2.textContent = chordData.name;
                drawFretboard(chordData);
            }
        }
        
        // --- Event Listeners ---
        modeChordButton.addEventListener('click', () => updateMode('chord'));
        modeScaleButton.addEventListener('click', () => updateMode('scale'));

        rootNoteSelect.addEventListener('change', updateVisualization);
        typeSelector.addEventListener('change', updateVisualization);
        positionSelector.addEventListener('change', updateVisualization); 

        // --- Initial Load ---
        rootNoteSelect.innerHTML = NOTE_INFO.map(note => 
            `<option value="${note.id}">${note.name}</option>`
        ).join('');
        rootNoteSelect.value = 4; // Default to E for consistency
        
        updateMode('chord'); // Start in Chord Mode
    </script>
</body>
</html>
